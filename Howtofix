local Players = game:GetService("Players")

local AllowedPlayers = AllowedPlayers or {}

local function isAllowed(player)
    for _, name in ipairs(AllowedPlayers) do
        if player.Name == name then
            return true
        end
    end
    return false
end

local AnimHandler = loadstring(game:HttpGet("https://raw.githubusercontent.com/ProudNamed/SuperLightning/refs/heads/main/AnimModule/MainModule"))()
local AltAnim = game:GetObjects("rbxassetid://15434683426")[1]
AltAnim.Parent = workspace
game:GetService("ContentProvider"):PreloadAsync({AltAnim})

local function playAltAnimation(character)
    local track = AnimHandler.new(character, AltAnim)
    track.TimePosition = 9.4
    track:Play()
    task.delay(1, function()
        track:Stop()
    end)
end

local function playShortAnimation(humanoid)
    local anim = Instance.new("Animation")
    anim.AnimationId = "rbxassetid://18896127525"
    local track = humanoid:LoadAnimation(anim)
    track:Play()
    task.delay(1, function()
        track:Stop()
    end)
end

local function playVFX(character, attachToRightLeg)
    local attachPart = character:WaitForChild("Right Arm")

    if attachToRightLeg then
        attachPart = character:WaitForChild("Right Leg")
    end

    local effectPaths = {
        game.ReplicatedStorage.Emotes.VFX.VfxMods.Flasher.char["Right Arm"]["2"],
        game.ReplicatedStorage.Emotes.VFX.VfxMods.Flasher.char["Right Arm"]["2"]["1"],
        game.ReplicatedStorage.Emotes.VFX.VfxMods.Flasher.char["Right Arm"]["2"].Emit2,
        game.ReplicatedStorage.Emotes.VFX.VfxMods.Flasher.char["Right Arm"]["1"],
    }

    local clonedEffects = {}
    for _, effect in ipairs(effectPaths) do
        local cloned = effect:Clone()
        cloned.Parent = attachPart
        table.insert(clonedEffects, cloned)
        for _, child in ipairs(cloned:GetDescendants()) do
            if child:IsA("ParticleEmitter") then
                child:Emit(1)
            end
        end
    end

    task.delay(0.5, function()
        for _, c in ipairs(clonedEffects) do
            c:Destroy()
        end
    end)
end

local function playSoundsAndFlash(player)
    task.spawn(function()
        wait(0.5)

        local function GetGitSound(GithubSnd, SoundName)
            local url = GithubSnd
            if not isfile(SoundName .. ".mp3") then
                writefile(SoundName .. ".mp3", game:HttpGet(url))
            end
            local sound = Instance.new("Sound")
            sound.SoundId = (getcustomasset or getsynasset)(SoundName .. ".mp3")
            sound.Volume = 4
            sound.Name = SoundName
            sound.RollOffMode = Enum.RollOffMode.Inverse
            sound.MaxDistance = 50
            sound.Parent = workspace
            return sound
        end

        local sound = GetGitSound(
            "https://github.com/NetlessScripter/Vegeta/blob/f69548941b7da7cea3406fe52ff642e18fb1ebc8/copy_3045D33D-79BC-4E7A-AAD4-683BEC38379B.mp3?raw=true",
            "BlackFlash2.0FULLACTUl"
        )
        sound:Play()

        local hrp = player.Character:WaitForChild("HumanoidRootPart")

        local part1 = Instance.new("Part")
        part1.Size = Vector3.new(1,1,1)
        part1.Anchored = true
        part1.CanCollide = false
        part1.Transparency = 1
        part1.CFrame = hrp.CFrame * CFrame.new(0, 0, -4)
        part1.Parent = workspace

        local blackFlash = game.ReplicatedStorage.Emotes.VFX.VfxMods.Flasher.vfx.BlackFlashFx.Main:Clone()
        blackFlash.Parent = part1
        for _, child in ipairs(blackFlash:GetChildren()) do
            if child:IsA("ParticleEmitter") then
                child.Enabled = false
                child:Emit(15)
            end
        end

        local part2 = Instance.new("Part")
        part2.Size = Vector3.new(1,1,1)
        part2.Anchored = true
        part2.CanCollide = false
        part2.Transparency = 1
        part2.CFrame = hrp.CFrame * CFrame.new(0, 0, -16)
        part2.Parent = workspace

        local lastImpact = game.ReplicatedStorage.Emotes.VFX.VfxMods.Flasher.vfx.LastImpactFx.Attachment:Clone()
        lastImpact.Parent = part2
        for _, child in ipairs(lastImpact:GetChildren()) do
            if child:IsA("ParticleEmitter") then
                child.Enabled = false
                child:Emit(15)
            end
        end
    end)
end

local function onAnimationPlayed(animationTrack, player)
    if not isAllowed(player) then return end

    if animationTrack.Animation.AnimationId == "rbxassetid://10468665991" then
        animationTrack:Stop()

        local character = player.Character or player.CharacterAdded:Wait()
        local humanoid = character:WaitForChild("Humanoid")

        local playedAlt = false
        if math.random() < 0.5 then
            playAltAnimation(character)
            playedAlt = true
        else
            playShortAnimation(humanoid)
        end

        playVFX(character, playedAlt)
        playSoundsAndFlash(player)
    end
end

local function setupPlayer(player)
    if isAllowed(player) then
        local function onCharacterAdded(character)
            local humanoid = character:WaitForChild("Humanoid")
            humanoid.AnimationPlayed:Connect(function(animationTrack)
                onAnimationPlayed(animationTrack, player)
            end)
        end
        if player.Character then
            onCharacterAdded(player.Character)
        end
        player.CharacterAdded:Connect(onCharacterAdded)
    end
end

for _, player in ipairs(Players:GetPlayers()) do
    setupPlayer(player)
end

Players.PlayerAdded:Connect(setupPlayer)
